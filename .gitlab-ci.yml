stages:
  - test
  - deploy

staging:test:
  stage: test
  image: python:3.9
  only: staging
  script:
  - python -m venv venv
  - source venv/bin/activate
  - pip install -r requirements.txt
  - python manage.py collectstatic --noinput
  - python manage.py migrate
  - python manage.py test

production:test:
  stage: test
  image: python:3.9
  only: master
  script:
  - python -m venv venv
  - source venv/bin/activate
  - pip install -r requirements.txt
  - python manage.py collectstatic --noinput
  - python manage.py migrate
  - python manage.py test

staging:deploy:
  stage: deploy
  image: nikolaik/python-nodejs:python3.9-nodejs16
  only:
    - staging
  script:
    - npm install --global vercel
    - vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
    - vercel build --token=$VERCEL_TOKEN
    - vercel deploy --prebuilt  --token=$VERCEL_TOKEN

production:deploy:
  stage: deploy
  image: nikolaik/python-nodejs:python3.9-nodejs16
  only:
    - master
  script:
    - npm install --global vercel
    - vercel pull --yes --environment=production --token=$VERCEL_TOKEN
    - vercel build --prod --token=$VERCEL_TOKEN
    - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN